<% issue = local_assigns[:issue] || @issue %>
<% f = local_assigns[:f] %>
<% project_id = issue&.project_id || @project&.id %>

<% contacts = [] %>
<% if project_id && defined?(Contact) %>
  <% contacts = Contact.joins("INNER JOIN contacts_projects ON contacts_projects.contact_id = contacts.id")
                       .where("contacts_projects.project_id = ?", project_id)
                       .order(:last_name, :first_name) %>
<% end %>

<% cf_id = Setting.plugin_redmine_contact_assigner['assigned_contact_custom_field_id'] %>
<% cf = cf_id.present? ? IssueCustomField.find_by(id: cf_id) : nil %>
<div class="attributes">
  <p>
    <%= label_tag nil, l(:field_assigned_contact) %>
    <% if cf_id.present? %>
      <% selected_value = issue.custom_field_value(cf_id) %>
      <% options = contacts.map { |c| [c.name, c.id] } %>
      <%= select_tag "contact_assigner_visible",
                     options_for_select([["", ""]] + options, selected_value),
                     class: 'assigned-contact', data: { testid: 'assigned-contact-select' } %>
      <script>
        (function() {
          var cfId = '<%= cf_id %>';
          function findOriginalField() {
            var sel = document.querySelector('[name="issue[custom_field_values][' + cfId + ']"], [name="issue[custom_field_values][' + cfId + '][]"]');
            return sel;
          }
          function syncToOriginal() {
            var visible = document.querySelector('[name="contact_assigner_visible"]');
            var orig = findOriginalField();
            if (!visible || !orig) return;
            var val = visible.value;
            if (orig.multiple) {
              Array.from(orig.options).forEach(function(o){ o.selected = (o.value === val); });
            } else {
              orig.value = val;
            }
          }
          function init() {
            var orig = findOriginalField();
            var visible = document.querySelector('[name="contact_assigner_visible"]');
            if (!orig || !visible) return;
            // Hide original CF UI to avoid duplicate controls
            var row = orig.closest('p, .attribute, .cf') || orig.parentElement;
            if (row) { row.style.display = 'none'; }
            // Initialize visible select from original value if any
            if (orig.multiple) {
              var selected = Array.from(orig.selectedOptions).map(function(o){ return o.value; });
              visible.value = selected[0] || '';
            } else {
              visible.value = orig.value || '';
            }
            visible.addEventListener('change', syncToOriginal);
          }
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
          } else { init(); }
        })();
      </script>
    <% else %>
      <span class="info">Bitte im Plugin-Setup ein Issue-Custom-Field ausw√§hlen.</span>
    <% end %>
  </p>
  <% if contacts.empty? %>
    <p class="info"><%= l(:text_no_project_contacts) %></p>
  <% end %>
  <% if cf_id.present? && issue.errors["custom_field_values"].present? %>
    <span class="error"><%= issue.errors["custom_field_values"].join(', ') %></span>
  <% end %>
  </div>
